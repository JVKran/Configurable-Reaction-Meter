#include "timer.hpp"

timer_c::timer_c(const uint16_t timer_base, const uint16_t irq_controller, const uint16_t irq_id):
		timer_base(timer_base),
		irq_controller(irq_controller),
		irq_id(irq_id)
{}

void timer_c::configure(const int microseconds, void (*callback)()){
	int counter = microseconds * 50;			// For example 1000us equals 50000 ticks.
	IOWR_ALTERA_AVALON_TIMER_PERIODL(timer_base, counter & ALTERA_AVALON_TIMER_PERIODL_MSK);
	IOWR_ALTERA_AVALON_TIMER_PERIODH(timer_base, (counter >> 16) & ALTERA_AVALON_TIMER_PERIODH_MSK);

	alt_ic_isr_register(irq_controller, irq_id, isr, 0, 0x0);
	m_callback = callback;

	int mask = ALTERA_AVALON_TIMER_CONTROL_CONT_MSK | ALTERA_AVALON_TIMER_CONTROL_ITO_MSK | ALTERA_AVALON_TIMER_CONTROL_START_MSK;
	IOWR_ALTERA_AVALON_TIMER_CONTROL(timer_base, mask);
}

void timer_c::start(){
	int mask = ALTERA_AVALON_TIMER_CONTROL_CONT_MSK | ALTERA_AVALON_TIMER_CONTROL_ITO_MSK | ALTERA_AVALON_TIMER_CONTROL_START_MSK;
	IOWR_ALTERA_AVALON_TIMER_CONTROL(timer_base, mask);
}

void timer_c::stop(){
	IOWR_ALTERA_AVALON_TIMER_CONTROL(timer_base, ALTERA_AVALON_TIMER_CONTROL_STOP_MSK);
}

void timer_c::isr(void* isr_context){
	timer_c* timer = (timer_c*)isr_context;
	timer->m_callback();
	IOWR_ALTERA_AVALON_TIMER_STATUS(TIMER_BASE, 0);
}
